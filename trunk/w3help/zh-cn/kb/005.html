<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../../zh-cn/css/common.css" media="all" />
<link rel="stylesheet" type="text/css" href="../../zh-cn/css/article.css" media="all" />
</head>
<body>
<!-- body_content { -->
<div class="body_content">
    <h1 class="title">KB005: CSS 层叠 </h1>
    <ul class="toc">
        <li><a href="#header_1">CSS 层叠及样式表来源</a> <span>•</span></li>
        <li><a href="#header_2">!important 规则</a> <span>•</span></li>
        <li><a href="#header_3">CSS 层叠顺序( Cascading order )</a> <span>•</span></li>
        <li><a href="#header_4">计算选择器的特殊性( Selector's specificity )</a> <span>•</span></li>
        <li><a href="#header_5">非 CSS 显示的优先级</a></li>
    </ul>
    <!-- } -->
    <!-- 文章正文 { -->
    <div id="w3h_content">
        <address class="author">作者：武利剑</address>
        <h2 id="header_1">CSS 层叠及样式表来源</h2>
        <p>Web标准化运动的口号——分离、分离、分离。</p>
        <p>在2003年的 <a href="http://sxsw.com/">SXSW</a> 会议中，
            Steve Champeon 和 Nick Finck 做了一个名为“<a href="http://www.hesketh.com/publications/inclusive_web_design_for_the_future/">面向未来的全方位 Web 设计</a>”的演讲，揭示了这种 Web 开发新方法的蓝图。
            Steve 还给它取了个名称：渐进增强（<a href="http://www.hesketh.com/publications/inclusive_web_design_for_the_future/">Progressive Enhancement</a>）。</p>
        <p><img src="005/Web%20module.png" /></p>
        <p>从内容花生开始，将其标记为富含语义的 (X)HTML，接着给内容裹上一层富含奶油的 CSS。
            最后，添加 JavaScript 作为糖果硬壳，这就做成了一颗可口无比的美味（并使得它不会在你手里融化）。<sup>1</sup></p>
        <p>CSS在其中扮演及其重要的角色。CSS 是 Cascading Style Sheets 的缩写，即层叠样式表。
           为什么叫做“层叠样式表”呢？这跟它的特征有关系：层叠。</p>
        <p>样式表可能有三种不同的来源：作者、用户和用户端。通俗的讲，作者就是开发者，用户就是使用浏览器的人，用户端就是浏览器。</p>
        <p>这三种来源的样式表可能在范围上有重叠。比如，都设置了 P 元素的背景色和字体颜色。它们根据层叠的规则互相作用。</p>
        <p>CSS 层叠对每一个样式规则<sup>2</sup>指定一个权重。如果要应用若干个规则，那么权重最大的那个规则具有优先权。</p>
        <p>缺省时，作者样式表规则较用户样式表规则优先级高。不过，对于 "!important" 规则，保留其优先级。所有的用户规则和作者规则的权重都比浏览器缺省样式表中规则的权重大。</p>

        <h3>用户端样式表</h3>
        <p>来自浏览器的样式，被称作 UA style，是浏览器默认的样式。
           比如，对于 DIV 元素，浏览器默认其 'display' 的特性值是 "block"，而 SPAN 是 "inline"。</p>
        <p>在 Firefox 的地址栏中输入：<span class="hl_4">resource://gre/res/html.css</span>，即可得到 Firefox 的浏览器默认样式表。</p>

        <h3>用户样式表</h3>
        <p>这个样式表是使用浏览器的用户，根据自己的偏好设置的样式表。</p>
        <p>比如，用户希望所有 P 元素中的字体都默认显示成蓝色，可以先定义一个样式表，存成 css 文件。CSS 代码：</p>
        <pre>
p{ color:blue; }</pre>
        <p>然后按下面的说明来设置即可。</p>
        <h4>1). IE</h4>
        <p>创建一个 CSS 文件，定义样式。然后，按如下图示，设置用户样式表，选择浏览，指向自定义样式。</p>
        <p><img src="005/IE style sheet.png" alt="IE 中设置用户样式表" /></p>
        <p></p>

        <h4>2). Firefox</h4>
        <p>按以下步骤：</p>
        <ol>
            <li>找到 Firefox 的 <a href="http://support.mozilla.com/zh-CN/kb/Profiles#locate">profile</a>，Windows 下在这里：用户名\AppData\Roaming\Mozilla\Firefox\Profiles\dbsujefc.default\chrome。
                <br/>也可以这样打开： 帮助-->疑难排解信息-->应用基础-->打开所在文件夹-->chrome；</li>
            <li>创建一个名为 userContent.css 的 CSS 文件，编辑加入所需要的样式。注意名字必须叫 userContent.css，不能更改。否则无效；</li>
            <li>保存 userContent.css 文件然后重启 Firefox。</li>
        </ol>

        <h4>3). Chrome</h4>
        <p>Chrome 定义用户样式的方式暂未找到。</p>

        <h4>4). Safari</h4>
        <p>创建一个 CSS 文件，定义样式。然后，按如下图示，设置用户样式表。</p>
        <p><img src="005/Safari style sheet.png" alt="Safari 中设置用户样式表" /></p>

        <h4>5). Opera</h4>
        <p>创建一个 CSS 文件，定义样式。然后，按如下图示，设置用户样式表。</p>
        <p><img src="005/opera style sheet.png" alt="Opera 中设置用户样式表" /></p>

        <h3>作者样式表</h3>
        <p>即开发者在开发网页时，所定义的样式表。</p>

        <p class="comment">注：</p>
        <ol class="comment">
            <li>以上内容译自<a href="http://www.alistapart.com/articles/understandingprogressiveenhancement">Understanding Progressive Enhancement</a>。最后一句话的幽默源自著名的巧克力广告词：只溶于口，不溶于手！</li>
            <li>这里说到的“规则”，通俗的讲，就是定义的样式，或者 <a href="/zh-cn/kb/002.html">CSS 声明</a>。</li>
        </ol>

        <h2 id="header_2">!important 规则<sup>1</sup></h2>
        <p>根据 CSS2.1 规范中的描述，'!important' 可以提高样式的优先级，它对样式优先级的影响是巨大的。
           注意，'!important' 规则在 IE7 以前的版本中是不被支持的。因此，经常被用作 CSS hack<sup>2</sup>。</p>
        <p>为了平衡开发者设置的样式和浏览器用户设定的样式，默认开发者的样式优于浏览器用户设置的样式；另外，声明了 '!important' 的样式优于普通声明。</p>

        <p class="comment">注：</p>
        <ol class="comment">
            <li>关于 '!important' 的详细信息，请参考 CSS2.1 规范 <a href="http://www.w3.org/TR/CSS2/cascade.html#important-rules">6.4.2 !important rules</a> 中的内容；</li>
            <li>见：<ul>
                    <li><a href="/zh-cn/causes/RY8003">W3Help - RY8003: 各浏览器对 CSS 错误解析规则的差异及 CSS hack</a></li>
                    <li><a href="http://topic.csdn.net/u/20100715/17/6306e40a-1ea1-4f0f-a1c3-acd7470800ea.html?18677">CSDN - 【分享】CSS Hack的基本原理、常用CSS hack及使用原则</a></li>
                </ul></li>
        </ol>

        <h2 id="header_3">CSS 层叠顺序( Cascading order )</h2>
        <p>为了找到元素/特性组合的值，用户端必须应用如下的排列顺序：</p>
        <ol>
            <li>对于目标媒介类型 (media type)，找到存有疑问的元素和属性的所有声明。如果相关联的选择器匹配存有疑问的元素，并且目标媒介匹配包含声明并且和样式表的路径在所有链接上达到一致的 @media 规则中所有的媒介列表。</li>
            <li>根据 CSS 样式的来源和重要性(是否含 !important )，给出了优先级的升序排列：
                <ul>
                    <li>用户端声明( UA declarations )</li>
                    <li>一般用户声明( user normal declarations )</li>
                    <li>一般作者声明( author normal declarations )</li>
                    <li>加了 '!important' 的作者声明( author important declarations )</li>
                    <li>加了 '!important' 的用户声明( user important declarations )</li>
                </ul>
            </li>
            <li>拥有相同重要性和来源的规则，按照 CSS specificity 来排序。此处，需要注意一下层叠顺序和选择器的特殊性<sup>1</sup>的关系。
                选择器的特殊性是在相同来源，相同重要性的规则之间判定最终哪个规则会起作用。
                比如， 同是开发者自己定义的样式，并且，没有使用 "!important" 规则，这样的样式才可以计算特殊性。</li>
            <li>最后，根据先后次序来排列：如果两条规则具有相同的权重，相同的来源和相同的选择器特殊性，则后出现的规则超越先出现的规则。
                引入的样式表( @import )中的规则被认为出现在样式表本身的所有规则之前。</li>
        </ol>
        <p>例：</p>

        <p>用户自定义样式，userContent.css：</p>
        <pre>
p{
    background-color:black;
    color:red !important;
}</pre>
        <p>按照上节中的做法，给浏览器设置用户样式。</p>

        <p>测试页面，test.html:</p>
        <pre>
&lt;style&gt;
    p {
        color: green !important;
    }
&lt;/style&gt;
&lt;p style="background-color : white; color : blue;"&gt; hello!! &lt;/p&gt;</pre>
        <p>可自行测试结果。</p>

        <p class="comment">注：</p>
        <ol class="comment">
            <li>选择器的特殊性，即下节的 Selector's specificity</li>
        </ol>

        <h2 id="header_4">计算选择器的特殊性( Selector's specificity )</h2>
        <p>正如上面提到的，根据层叠顺序，优先级相同的样式，如何判断哪一条声明会起作用，取决于对其选择器特殊性的计算值。</p>
        <p>例如，都是作者样式，并且没有使用 '!important' 规则：</p>
        <pre>
&lt;!DOCTYPE HTML&gt;
&lt;style type="text/css"&gt;
    div {
        width: 100px;
        height: 100px;
    }
    #c1 #c2 div.con {
        background-color: yellow;
    }
    div {
        background-color: black;
    }
    #c2 div {
        background-color: blue;
    }
    #c2 #content {
        background-color: red;
    }
&lt;/style&gt;
&lt;div id="c1"&gt;
    &lt;div id="c2"&gt;
        &lt;div id="<span class="hl_2">content</span>" class="con"&gt;&lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;</pre>
        <p>如上代码中，多个样式中的 'background-color' 同时作用于 <span class="hl_2">content</span>，那么最后，到底 <span class="hl_2">content</span> 应该会是什么颜色呢？</p>
        <p>这就应该求助于选择器特殊性的计算规则了。</p>
        <p>特殊性的值可以看作是一个由四个数组成的一个组合，用 a，b，c，d 来表示它的四个位置。
            依次比较 a，b，c，d 这个四个数比较其特殊性的大小。比如，a 值相同，那么 b 值大的组合特殊性会较大，以此类推。
            注意，W3C 中并不是把它作为一个 4 位数来看待的。
        </p>
        <p>a，b，c，d 值的确定规则：</p>
        <ol>
            <li>如果 HTML 标签的 'style' 属性中该样式存在，则记 a 为 1；</li>
            <li>数一下选择器中 ID 选择器的个数作为 b 的值。比如，以上样式中包含 '#c1' 和 '#c2' 的选择器；</li>
            <li>其他属性以及伪类（pseudo-classes）的总数量是 c 的值。比如，上面例子中的 '.con'，':hover' 等；</li>
            <li>元素名和伪元素的数量是 d 的值；比如上面例子中的 ‘div’。</li>
        </ol>
        <p>现在，应用上面的规则，计算例子中各个样式的特殊性的值，结果为：</p>
        <pre>
&lt;!DOCTYPE HTML&gt;
&lt;style type="text/css"&gt;
    div {
        width: 100px;
        height: 100px;
    }
    #c1 #c2 div.con {     /* a=0 b=2 c=1 d=1 -&gt; specificity = <span class="hl_1">0,2,1,1</span> */
        background-color: yellow;
    }
    div {                 /* a=0 b=0 c=0 d=1 -&gt; specificity = <span class="hl_2">0,0,0,1</span> */
        background-color: black;
    }
    #c2 div {             /* a=0 b=1 c=0 d=1 -&gt; specificity = <span class="hl_3">0,1,0,1</span> */
        background-color: blue;
    }
    #c2 #content {        /* a=0 b=2 c=0 d=0 -&gt; specificity = <span class="hl_4">0,2,0,0</span> */
        background-color: red;
    }
&lt;/style&gt;
&lt;div id="c1"&gt;
    &lt;div id="c2"&gt;
        &lt;div id="content" class="con"&gt;&lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;</pre>
        <p>可见，'#c1 #c2 div.con" 的特殊性( [0,2,1,1] )最高，是背景色应该是黄色。</p>
        <p>W3C 官方给出的例子：</p>
        <pre>
*             {}  /* a=0 b=0 c=0 d=0 -&gt; specificity = <span class="hl_1">0,0,0,0</span> */
li            {}  /* a=0 b=0 c=0 d=1 -&gt; specificity = <span class="hl_2">0,0,0,1</span> */
li:first-line {}  /* a=0 b=0 c=0 d=2 -&gt; specificity = <span class="hl_3">0,0,0,2</span> */
ul li         {}  /* a=0 b=0 c=0 d=2 -&gt; specificity = <span class="hl_4">0,0,0,2</span> */
ul ol+li      {}  /* a=0 b=0 c=0 d=3 -&gt; specificity = <span class="hl_5">0,0,0,3</span> */
h1 + *[rel=up]{}  /* a=0 b=0 c=1 d=1 -&gt; specificity = <span class="hl_4">0,0,1,1</span> */
ul ol li.red  {}  /* a=0 b=0 c=1 d=3 -&gt; specificity = <span class="hl_1">0,0,1,3</span> */
li.red.level  {}  /* a=0 b=0 c=2 d=1 -&gt; specificity = <span class="hl_2">0,0,2,1</span> */
#x34y         {}  /* a=0 b=1 c=0 d=0 -&gt; specificity = <span class="hl_3">0,1,0,0</span> */
style=""          /* a=1 b=0 c=0 d=0 -&gt; specificity = <span class="hl_2">1,0,0,0</span> */
------------------------------------------------------------------------
&lt;HEAD&gt;
&lt;STYLE type="text/css"&gt;
 #x97z { color: red }
&lt;/STYLE&gt;
&lt;/HEAD&gt;
&lt;BODY&gt;
&lt;P ID=x97z style="color: green"&gt;
&lt;/BODY&gt;</pre>
        <p>如上代码中，P 中字体的颜色应该为绿色。</p>

        <h2 id="header_5">非 CSS 显示的优先级</h2>
        <p>用户端应该优先考虑那些不是来自样式表的显示属性。如果是这样，这些非CSS呈现提示必须被转换到相应的CSS规则，
            且其特殊性为零( 既，使其特殊性最低 )，并认为它的引入处于样式表的最顶端。它们可能被后续的样式规则所覆盖，</p>
        <p>在 HTML 中，任何不属于以下列表中的属性都需要以显示属性对待：abbr, accept-charset,
            accept, accesskey, action, alt, archive, axis, charset,
            checked, cite, class, classid, code, codebase, codetype,
            colspan, coords, data, datetime, declare, defer, dir,
            disabled, enctype, for, headers, href, hreflang, http-equiv,
            id, ismap, label, lang, language, longdesc, maxlength, media,
            method, multiple, name, nohref, object, onblur, onchange, onclick,
            ondblclick, onfocus, onkeydown, onkeypress, onkeyup, onload, onload,
            onmousedown, onmousemove, onmouseout, onmouseover, onmouseup, onreset,
            onselect, onsubmit, onunload, onunload, profile, prompt, readonly, rel,
            rev, rowspan, scheme, scope, selected, shape, span, src, standby, start,
            style, summary, title, type (except on LI, OL and UL elements), usemap,
            value, valuetype, version. </p>

        <p>例如，对于 align<sup>1</sup> 属性，各浏览器应当将它转换成 CSS 中的浮动。</p>

        <p class="comment">注：</p>
        <ol class="comment">
            <li>相关问题和解释，请参见：<a href="/zh-cn/causes/RX8015">W3Help -- RX8015: IE6 IE7 IE8(Q) 没有完全正确地将 IMG、OBJECT、IFRAME、TABLE 元素的 align=&quot;left|right&quot; 理解为浮动</a></li>
        </ol>

        <div class="appendix">
            <h2>测试环境</h2>
            <table class="list">
                <tr>
                    <th>操作系统版本:</th>
                    <td>Windows 7 Ultimate build 7600</td>
                </tr>
                <tr>
                    <th>浏览器版本:</th>
                    <td>
                        IE6<br />
                        IE7<br />
                        IE8<br />
                        Firefox 3.6.10<br />
                        Chrome 7.0.517.0 dev<br />
                        Safari 5.0.2<br />
                        Opera 10.62
                    </td>
                </tr>
                <tr>
                    <th>测试页面:</th>
                    <td>&nbsp;</td>
                </tr>
                <tr>
                    <th>本文更新时间:</th>
                    <td>2010-09-15</td>
                </tr>
            </table>

            <h2>关键字</h2>
            <p>CSS 层叠 !important 规则 样式表来源 层叠顺序 特殊性 选择器 非CSS 显示</p>
        </div>
    </div>
    <!-- } -->
</div>
<!-- } body_content -->
</body>
</html>
